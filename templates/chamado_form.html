{% extends "base.html" %}

{% block title %}Novo Atendimento | WT{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h2 class="h4 fw-bold text-gray-800"><i class="bi bi-clipboard-plus me-2"></i>Novo Atendimento
            </h2>
            <p class="text-muted small">Cadastre um deslocamento e múltiplos chamados (FSAs) de uma só vez.</p>
        </div>
    </div>

    <form id="masterForm" onsubmit="submitMasterForm(event)">
        <!-- 1. HEADER LOGÍSTICO -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light fw-bold text-primary">
                <i class="bi bi-geo-alt me-2"></i> Dados Logísticos
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Técnico Responsável *</label>
                        <select name="tecnico_id" id="tecnico_id" class="form-select" required>
                            <option value="">Selecione...</option>
                            {% for doc in tecnicos %}
                            <option value="{{ doc.id }}">{{ doc.nome }} ({{ doc.id_tecnico }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Data Atendimento *</label>
                        <input type="date" name="data_atendimento" id="data_atendimento" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Cliente / Contrato *</label>
                        <select name="cliente_id" id="cliente_id" class="form-select" required
                            onchange="onClienteChange()">
                            <option value="">Carregando...</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Cidade / Local *</label>
                        <input type="text" name="cidade" id="cidade" class="form-control"
                            placeholder="Ex: Shopping Iguatemi, São Paulo" required>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. DETALHES (FSAs) -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <span class="fw-bold text-success">
                    <i class="bi bi-list-check me-2"></i> Chamados (FSAs)
                </span>
                <button type="button" class="btn btn-sm btn-success" onclick="addFsaRow()">
                    <i class="bi bi-plus-lg"></i> Adicionar FSA
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered mb-0 align-middle" id="fsaTable">
                        <thead class="bg-light">
                            <tr>
                                <th style="width: 4%">#</th>
                                <th style="width: 14%">Código FSA</th>
                                <th style="width: 25%">Serviço *</th>
                                <th style="width: 8%">Horas</th>
                                <th style="width: 20%" id="pecaHeader">Peça LPU</th>
                                <th style="width: 10%">Fornecedor</th>
                                <th style="width: 10%">Custo (R$)</th>
                                <th style="width: 4%"></th>
                            </tr>
                        </thead>
                        <tbody id="fsaTableBody">
                            <!-- Rows will be injected here by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-white text-muted small">
                * Primeiro FSA = "Principal". Os demais = "Carona" (Adicional). Pagamento calculado automaticamente.
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2">
            <a href="{{ url_for('operacional.chamados') }}" class="btn btn-outline-secondary">Cancelar</a>
            <button type="submit" class="btn btn-primary px-4">
                <i class="bi bi-save me-2"></i> Salvar Atendimento
            </button>
        </div>
    </form>
</div>

<script>
    // Global data store
    let contratosData = { clientes: [] };
    let currentClienteId = null;
    let rowCount = 0;

    // Fetch contract data on page load
    async function loadContratosData() {
        try {
            const response = await fetch('/api/dados_contrato');
            if (!response.ok) throw new Error('Erro ao carregar dados');
            contratosData = await response.json();
            populateClienteSelect();
        } catch (err) {
            console.error(err);
            document.getElementById('cliente_id').innerHTML = '<option value="">Erro ao carregar</option>';
        }
    }

    function populateClienteSelect() {
        const select = document.getElementById('cliente_id');
        select.innerHTML = '<option value="">Selecione o Cliente...</option>';

        contratosData.clientes.forEach(c => {
            select.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
        });
    }

    function onClienteChange() {
        const clienteId = document.getElementById('cliente_id').value;
        currentClienteId = clienteId ? parseInt(clienteId) : null;

        // Update all existing rows with new service options
        document.querySelectorAll('.servico-select').forEach(select => {
            updateServicoOptions(select);
        });

        document.querySelectorAll('.peca-lpu-select').forEach(select => {
            updateLpuOptions(select);
        });
    }

    function getClienteData() {
        if (!currentClienteId) return null;
        return contratosData.clientes.find(c => c.id === currentClienteId);
    }

    function updateServicoOptions(selectEl) {
        const cliente = getClienteData();
        const currentValue = selectEl.value;
        selectEl.innerHTML = '<option value="">-- Selecione o Serviço --</option>';

        if (cliente && cliente.servicos) {
            cliente.servicos.forEach(s => {
                // data-exige-peca e data-franquia para lógica condicional
                selectEl.innerHTML += `<option value="${s.id}" 
                    data-valor="${s.valor}" 
                    data-exige-peca="${s.exige_peca}" 
                    data-franquia="${s.horas_franquia}"
                    data-paga-tecnico="${s.paga_tecnico}">
                    ${s.nome} (R$ ${s.valor.toFixed(2)})
                </option>`;
            });
        }
    }

    function updateLpuOptions(selectEl) {
        const cliente = getClienteData();
        selectEl.innerHTML = '<option value="">-- Nenhuma --</option>';

        if (cliente && cliente.lpu) {
            cliente.lpu.forEach(l => {
                selectEl.innerHTML += `<option value="${l.id}" data-valor="${l.valor}">
                    ${l.nome} (R$ ${l.valor.toFixed(2)})
                </option>`;
            });
        }
    }

    function addFsaRow() {
        rowCount++;
        const tbody = document.getElementById('fsaTableBody');
        const tr = document.createElement('tr');
        tr.id = `row-${rowCount}`;
        tr.dataset.rowId = rowCount;

        tr.innerHTML = `
            <td class="text-center fw-bold text-muted">${rowCount}</td>
            <td>
                <input type="text" class="form-control form-control-sm" 
                    name="codigo_chamado_${rowCount}" placeholder="FSA-12345 ou URL Jira" required>
            </td>
            <td>
                <select class="form-select form-select-sm servico-select" name="servico_${rowCount}" 
                    onchange="onServicoChange(this, ${rowCount})" required>
                    <option value="">-- Serviço --</option>
                </select>
            </td>
            <td>
                <input type="number" step="0.5" min="0.5" max="12" class="form-control form-control-sm" 
                    name="horas_${rowCount}" value="2" required>
            </td>
            <td class="peca-cell" id="peca-cell-${rowCount}">
                <select class="form-select form-select-sm peca-lpu-select" name="peca_usada_${rowCount}">
                    <option value="">-- Nenhuma --</option>
                </select>
            </td>
            <td>
                <select class="form-select form-select-sm" name="fornecedor_peca_${rowCount}" 
                    onchange="checkSupplier(this, ${rowCount})">
                    <option value="Empresa">Empresa</option>
                    <option value="Tecnico">Técnico</option>
                </select>
            </td>
            <td>
                <input type="number" step="0.01" class="form-control form-control-sm" 
                    name="custo_peca_${rowCount}" placeholder="0.00" disabled>
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-ghost-danger btn-icon" onclick="removeRow(${rowCount})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);

        // Populate dynamic selects
        const servicoSelect = tr.querySelector('.servico-select');
        const lpuSelect = tr.querySelector('.peca-lpu-select');
        updateServicoOptions(servicoSelect);
        updateLpuOptions(lpuSelect);
    }

    function removeRow(id) {
        const tr = document.getElementById(`row-${id}`);
        if (tr) tr.remove();
    }

    function onServicoChange(select, rowId) {
        const option = select.options[select.selectedIndex];
        const exigePeca = option.dataset.exigePeca === 'true';
        const franquia = option.dataset.franquia || 2;

        const pecaCell = document.getElementById(`peca-cell-${rowId}`);
        const pecaSelect = pecaCell.querySelector('.peca-lpu-select');
        const horasInput = document.querySelector(`input[name="horas_${rowId}"]`);

        // Set default horas based on franquia
        horasInput.value = franquia;

        // Toggle LPU visibility/requirement based on exige_peca
        if (exigePeca) {
            pecaCell.style.opacity = '1';
            pecaSelect.required = true;
            pecaSelect.disabled = false;
        } else {
            pecaCell.style.opacity = '0.5';
            pecaSelect.required = false;
            pecaSelect.value = '';
        }
    }

    function checkSupplier(select, id) {
        const inputCusto = document.querySelector(`input[name="custo_peca_${id}"]`);
        if (select.value === 'Tecnico') {
            inputCusto.disabled = false;
            inputCusto.required = true;
            inputCusto.focus();
        } else {
            inputCusto.disabled = true;
            inputCusto.value = '';
            inputCusto.required = false;
        }
    }

    async function submitMasterForm(e) {
        e.preventDefault();

        const form = document.getElementById('masterForm');
        const cliente = getClienteData();

        // Build logistica object
        const logistica = {
            tecnico_id: document.getElementById('tecnico_id').value,
            data_atendimento: document.getElementById('data_atendimento').value,
            cidade: document.getElementById('cidade').value,
            cliente_id: currentClienteId,
            cliente_nome: cliente ? cliente.nome : ''
        };

        // Build FSA list
        const fsas = [];
        document.querySelectorAll('#fsaTableBody tr').forEach(tr => {
            const rowId = tr.dataset.rowId;
            if (!rowId) return;

            const servicoSelect = tr.querySelector(`select[name="servico_${rowId}"]`);
            const servicoOption = servicoSelect.options[servicoSelect.selectedIndex];
            const pecaSelect = tr.querySelector(`select[name="peca_usada_${rowId}"]`);
            const pecaOption = pecaSelect ? pecaSelect.options[pecaSelect.selectedIndex] : null;

            fsas.push({
                codigo_chamado: form.querySelector(`input[name="codigo_chamado_${rowId}"]`).value,
                catalogo_servico_id: servicoSelect.value,
                catalogo_servico_nome: servicoOption ? servicoOption.text : '',
                catalogo_servico_valor: servicoOption ? servicoOption.dataset.valor : 0,
                horas_trabalhadas: parseFloat(form.querySelector(`input[name="horas_${rowId}"]`).value) || 2,
                peca_id: pecaSelect ? pecaSelect.value : '',
                peca_usada: pecaOption && pecaOption.value ? pecaOption.text : '',
                peca_valor: pecaOption && pecaOption.dataset ? pecaOption.dataset.valor : 0,
                fornecedor_peca: form.querySelector(`select[name="fornecedor_peca_${rowId}"]`).value,
                custo_peca: parseFloat(form.querySelector(`input[name="custo_peca_${rowId}"]`).value) || 0
            });
        });

        if (fsas.length === 0) {
            alert('Adicione pelo menos um FSA.');
            return;
        }

        try {
            const response = await fetch('/chamados/criar/multiplo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ logistica, fsas })
            });

            const result = await response.json();

            if (response.ok) {
                alert('✅ ' + (result.message || 'Atendimento registrado com sucesso!'));
                window.location.href = '{{ url_for('operacional.atendimentos') }}';
            } else {
                alert('❌ Erro: ' + (result.error || 'Erro desconhecido'));
            }
        } catch (err) {
            alert('❌ Erro de rede: ' + err.message);
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadContratosData();
        addFsaRow(); // Start with one row

        // Set today's date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('data_atendimento').value = today;
    });
</script>
{% endblock %}