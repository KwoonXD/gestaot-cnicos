{% extends 'base.html' %}

{% block title %}Importar Técnicos - Gestão de Contratos{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-cloud-upload-fill"></i> Importar Técnicos</h1>
    <a href="{{ url_for('operacional.tecnicos') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Voltar
    </a>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <div class="alert alert-info">
                    <h5><i class="bi bi-info-circle"></i> Instruções</h5>
                    <ul class="mb-0">
                        <li>O arquivo deve ser <b>.csv</b> ou <b>.xlsx</b>.</li>
                        <li>Colunas obrigatórias: <b>Nome</b>, <b>Documento (CPF/CNPJ)</b>.</li>
                        <li>Colunas opcionais: <b>Telefone, Cidade, Estado, PIX</b>.</li>
                        <li>Técnicos já existentes (pelo CPF) serão atualizados.</li>
                    </ul>
                </div>

                <form id="formImport" action="{{ url_for('operacional.importar_tecnicos_post') }}" method="POST"
                    enctype="multipart/form-data">
                    <div class="mb-4">
                        <label for="file" class="form-label fw-bold">Selecione o arquivo</label>
                        <input class="form-control form-control-lg" type="file" id="file" name="file"
                            accept=".csv, .xlsx" required>
                    </div>

                    <div class="d-grid gap-2">
                        <!-- Step 1: Analyze -->
                        <button type="button" id="btnAnalisar" class="btn btn-info text-white"
                            onclick="analisarArquivo()">
                            <i class="bi bi-search"></i> Analisar Arquivo
                        </button>

                        <!-- Step 2: Process (Initially Disabled) -->
                        <button type="submit" id="btnProcessar" class="btn btn-primary" disabled>
                            <i class="bi bi-cloud-arrow-up-fill"></i> Processar Importação
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Analysis -->
<div class="modal fade" id="modalAnalysis" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Análise do Arquivo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="analysisLoading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Analisando dados...</p>
                </div>

                <div id="analysisResult" style="display: none;">
                    <!-- Summary -->
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    <small class="text-muted">Total Linhas</small>
                                    <h4 id="statTotal">-</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-8">
                            <div class="alert alert-warning py-2 mb-0" id="statMsg">
                                Verificar colunas mapeadas
                            </div>
                        </div>
                    </div>

                    <!-- Mapping Status -->
                    <h6 class="border-bottom pb-2">Colunas Identificadas</h6>
                    <div class="row mb-3" id="mappingList"></div>

                    <!-- Preview Table -->
                    <h6 class="border-bottom pb-2">Preview (10 linhas)</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered" style="font-size: 0.85rem;">
                            <thead class="table-light" id="previewHead"></thead>
                            <tbody id="previewBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="analysisError" class="alert alert-danger" style="display: none;"></div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-success" id="btnConfirmarAnalise"
                    onclick="habilitarProcessamento()" disabled>
                    <i class="bi bi-check-lg"></i> Confirmar e Habilitar
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    async function analisarArquivo() {
        const fileInput = document.getElementById('file');
        if (!fileInput.files.length) {
            alert("Selecione um arquivo primeiro.");
            return;
        }

        // Show Modal
        const modal = new bootstrap.Modal(document.getElementById('modalAnalysis'));
        modal.show();

        // UI Reset
        document.getElementById('analysisLoading').style.display = 'block';
        document.getElementById('analysisResult').style.display = 'none';
        document.getElementById('analysisError').style.display = 'none';
        document.getElementById('btnConfirmarAnalise').disabled = true;

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
            const response = await fetch('/api/importar/analisar', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            document.getElementById('analysisLoading').style.display = 'none';

            if (!data.success && !data.mapping) { // Error
                const errDiv = document.getElementById('analysisError');
                errDiv.innerText = data.error || data.message || "Erro desconhecido";
                errDiv.style.display = 'block';
                return;
            }

            // Success Logic
            document.getElementById('analysisResult').style.display = 'block';
            document.getElementById('statTotal').innerText = data.total_rows;

            // Mapping Logic
            const mapDiv = document.getElementById('mappingList');
            mapDiv.innerHTML = '';
            let valid = true;

            for (const [key, val] of Object.entries(data.mapping)) {
                const hasVal = val !== null;
                const isReq = (key === 'nome' || key === 'documento');

                if (isReq && !hasVal) valid = false;

                const colItem = `
                <div class="col-md-6 mb-1">
                    <div class="d-flex justify-content-between border rounded p-2 ${hasVal ? 'bg-light' : (isReq ? 'bg-danger-subtle' : '')}">
                        <span class="fw-bold">${key.toUpperCase()}</span>
                        <span class="${hasVal ? 'text-success' : 'text-muted'}">
                            ${hasVal ? val : (isReq ? '<i class="bi bi-exclamation-triangle"></i> Ausente' : 'Não encontrado')}
                        </span>
                    </div>
                </div>
            `;
                mapDiv.innerHTML += colItem;
            }

            // Block confirmation if invalid
            const confirmBtn = document.getElementById('btnConfirmarAnalise');
            const statMsg = document.getElementById('statMsg');

            if (valid) {
                confirmBtn.disabled = false;
                statMsg.className = "alert alert-success py-2 mb-0";
                statMsg.innerText = "Mapeamento Válido! Pode prosseguir.";
            } else {
                confirmBtn.disabled = true;
                statMsg.className = "alert alert-danger py-2 mb-0";
                statMsg.innerText = "Colunas obrigatórias faltando.";
            }

            // Preview Table
            const thead = document.getElementById('previewHead');
            const tbody = document.getElementById('previewBody');

            // Headers
            thead.innerHTML = '<tr>' + data.columns.map(c => `<th>${c}</th>`).join('') + '</tr>';

            // Rows
            let rowsHtml = '';
            data.preview.forEach(row => {
                rowsHtml += '<tr>';
                data.columns.forEach(col => {
                    let cell = row[col];
                    // Truncate long
                    if (cell && cell.toString().length > 30) cell = cell.toString().substring(0, 30) + '...';
                    rowsHtml += `<td>${cell || ''}</td>`;
                });
                rowsHtml += '</tr>';
            });
            tbody.innerHTML = rowsHtml;

        } catch (e) {
            console.error(e);
            document.getElementById('analysisLoading').style.display = 'none';
            const errDiv = document.getElementById('analysisError');
            errDiv.innerText = "Erro na requisição: " + e.message;
            errDiv.style.display = 'block';
        }
    }

    function habilitarProcessamento() {
        document.getElementById('btnProcessar').disabled = false;
        document.getElementById('btnProcessar').classList.add('pulse-animation');
        // Close modal
        const modalEl = document.getElementById('modalAnalysis');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
    }
</script>

<style>
    .pulse-animation {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7);
        }

        70% {
            transform: scale(1.02);
            box-shadow: 0 0 0 10px rgba(13, 110, 253, 0);
        }

        100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(13, 110, 253, 0);
        }
    }
</style>
{% endblock %}